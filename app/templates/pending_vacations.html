{% extends "base.html" %}
{% block title %}ìŠ¹ì¸ ëŒ€ê¸° íœ´ê°€ - ê°€ìì—°ì„¸ë³‘ì› ì—°ì°¨ê´€ë¦¬ ì‹œìŠ¤í…œ{% endblock %}
{% block content %}
<div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-lg border border-sky-100 py-5 px-4 md:px-6 mt-[0px] sm:mt-[8px] md:mt-[8px]">

  <!-- âœ… íƒ€ì´í‹€ -->
  <div class="flex items-center justify-center md:justify-start gap-2 mb-4">
    <i data-lucide="clipboard-list" class="w-6 h-6 text-sky-700"></i>
    <span class="text-sky-800 font-bold text-xl md:text-2xl">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íœ´ê°€ ì‹ ì²­</span>
  </div>

  {% if vacations %}
  <div class="overflow-x-auto rounded-xl border border-sky-100 shadow-inner">
    <table class="min-w-full text-sm border-collapse">
      <thead class="bg-gradient-to-r from-sky-50 to-sky-100 text-sky-700 border-b border-sky-200">
        <tr>
          <th class="py-2 px-2 border-r border-sky-200">ë‚ ì§œ</th>
          <th class="py-2 px-2 border-r border-sky-200">ì´ë¦„</th>
          <th class="py-2 px-2 border-r border-sky-200">ì¢…ë¥˜</th>
          <th class="py-2 px-2 border-r border-sky-200">ì‹ ì²­ì¼ (ì‹œê°„)</th>
          <th class="py-2 px-2 border-r border-sky-200">ìŠ¹ì¸</th>
          <th class="py-2 px-2">ì‚­ì œ</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-100 text-center">
        {% for v in vacations %}
        <tr class="hover:bg-sky-50 transition">
          <td class="py-2 border-r border-slate-100">
            {{ v.start_date }}
            {% if v.end_date != v.start_date %}
              ~ {{ v.end_date }}
            {% endif %}
          </td>
          <td class="py-2 border-r border-slate-100 font-medium">
            {% if v.target_user %}
                {{ v.target_user.last_name }}{{ v.target_user.first_name }}
            {% else %}
                {# v.name = first_name ì¼ ë•Œ â†’ User í…Œì´ë¸”ì—ì„œ full name ì°¾ì•„ì˜¤ê¸° #}
                {% for u in users %}
                    {% if u.first_name == v.name %}
                        {{ u.last_name }}{{ u.first_name }}
                    {% endif %}
                {% endfor %}
            {% endif %}
          </td>
          <td class="py-2 border-r border-slate-100">{{ v.type }}</td>
          <td class="py-2 border-r border-slate-100 text-slate-500">
            {{ v.created_at.strftime('%Y-%m-%d %H:%M') }}
          </td>
          <td class="py-2 border-r border-slate-100">
            <button
              class="approve-btn bg-sky-500 hover:bg-sky-600 text-white px-3 py-1 rounded-lg shadow-sm transition"
              data-id="{{ v.id }}">
              ìŠ¹ì¸
            </button>
          </td>
          <td class="py-2">
            <button
              class="reject-btn bg-rose-500 hover:bg-rose-600 text-white px-3 py-1 rounded-lg shadow-sm transition"
              data-id="{{ v.id }}">
              ì‚­ì œ
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="text-center text-slate-500 text-sm mt-6">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ íœ´ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
  {% endif %}
</div>

<!-- âœ… ë°˜ì‘í˜• -->
<style>
@media (max-width: 768px) {
  table { font-size: 0.85rem; }
  th, td { white-space: nowrap; }
}
</style>

<!-- âœ… í† ìŠ¤íŠ¸ ì•Œë¦¼ -->
<style>
.toast {
  position: fixed;
  top: 16px;
  left: 50%;
  transform: translateX(-50%);
  color: white;
  padding: 10px 18px;
  border-radius: 8px;
  font-size: 0.9rem;
  font-weight: 500;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  opacity: 0;
  transition: opacity 0.4s ease, transform 0.4s ease;
  z-index: 9999;
}
.toast.show {
  opacity: 1;
  transform: translate(-50%, 0);
}

/* âœ… ìƒ‰ìƒ êµ¬ë¶„ */
.toast.success { background: rgba(14,165,233,0.95); }  /* íŒŒë‘ - ìŠ¹ì¸ */
.toast.error { background: rgba(239,68,68,0.95); }     /* ë¹¨ê°• - ì‹¤íŒ¨ */
.toast.info { background: rgba(107,114,128,0.95); }    /* íšŒìƒ‰ - ì¼ë°˜ */
</style>

<!-- âœ… ìŠ¹ì¸ / ì‚­ì œ + í† ìŠ¤íŠ¸ ê¸°ëŠ¥ -->
<script>
function showToast(message, type = "info") {
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.classList.add("show"), 10);
  setTimeout(() => {
    toast.classList.remove("show");
    setTimeout(() => toast.remove(), 400);
  }, 2000);
}

document.addEventListener("DOMContentLoaded", () => {

  // ìŠ¹ì¸
  document.querySelectorAll(".approve-btn").forEach(btn => {
    btn.addEventListener("click", async e => {
      const id = e.target.dataset.id;
      try {
        const res = await axios.post(`/vacation/approve_vacation/${id}`);
        if (res.data.status === "success") {
          showToast("âœ… " + res.data.message, "success");
          setTimeout(() => location.reload(), 1200);
        } else {
          showToast(res.data.message || "ìŠ¹ì¸ ì‹¤íŒ¨", "error");
        }
      } catch (err) {
        showToast("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
      }
    });
  });

  // ì‚­ì œ
  document.querySelectorAll(".reject-btn").forEach(btn => {
    btn.addEventListener("click", async e => {
      const id = e.target.dataset.id;
      try {
        const res = await axios.delete(`/vacation/delete/${id}`);
        if (res.data.status === "success") {
          showToast("ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "info");
          setTimeout(() => location.reload(), 1000);
        } else {
          showToast(res.data.message || "ì‚­ì œ ì‹¤íŒ¨", "error");
        }
      } catch (err) {
        showToast("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
      }
    });
  });
});
</script>

{% endblock %}
