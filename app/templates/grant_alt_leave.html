{% extends "base.html" %}
{% block content %}
<div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-lg border border-sky-100 py-4 px-4 mt-[0px] sm:mt-[8px] md:mt-[8px]">

  <!-- âœ… íƒ­ í—¤ë” -->
  <div class="flex justify-center mb-6">
    <button id="tabGrant" 
            class="tab-btn active px-4 py-2 text-sky-600 font-semibold text-sm sm:text-base whitespace-nowrap border-b-2 border-sky-500">
      ëŒ€ì²´ì—°ì°¨ ë¶€ì—¬
    </button>
    <button id="tabHistory" 
            class="tab-btn px-4 py-2 text-slate-500 font-semibold text-sm sm:text-base whitespace-nowrap hover:text-sky-600">
      ëŒ€ì²´ì—°ì°¨ ì´ë ¥
    </button>
  </div>

  <!-- âœ… íƒ­ 1 : ëŒ€ì²´ì—°ì°¨ ë¶€ì—¬ -->
  <section id="grantSection" class="tab-section block">
    <form id="grantForm" method="POST" class="space-y-5">
      <!-- ìƒë‹¨ ì…ë ¥ -->
      <div class="flex flex-wrap justify-center gap-4 text-sm">
        <div class="flex items-center gap-2">
          <label class="font-medium text-slate-700">ë¶€ì—¬ ì¼ìˆ˜</label>
          <input type="number" name="add_days" step="0.25" min="0.25"
                 class="border border-sky-200 bg-gradient-to-r from-sky-50 to-white rounded-lg px-3 py-2 w-24 text-center focus:ring-2 focus:ring-sky-400 focus:outline-none shadow-sm" required>
        </div>
        <div class="flex items-center gap-2">
          <label class="font-medium text-slate-700">ì ìš©ì¼ì</label>
          <input type="date" name="apply_date"
                 class="border border-sky-200 bg-gradient-to-r from-sky-50 to-white rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-sky-400 focus:outline-none shadow-sm" required>
        </div>
        <div class="flex items-center gap-2 flex-grow">
          <label class="font-medium text-slate-700 whitespace-nowrap">ì‚¬ìœ </label>
          <input type="text" name="reason" placeholder="ì˜ˆ: ê³µíœ´ì¼ ëŒ€ì²´, ë³‘ì› í–‰ì‚¬ ë“±"
                 class="flex-grow border border-sky-200 bg-gradient-to-r from-sky-50 to-white rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-400 focus:outline-none shadow-sm">
        </div>
        <button type="submit"
                class="bg-sky-600 hover:bg-sky-700 text-white font-semibold px-6 py-2 rounded-lg shadow-md transition">
          ì„ íƒìì—ê²Œ ë¶€ì—¬
        </button>
      </div>

      <!-- âœ… ë¶€ì„œë³„ ì§ì› ì¹´ë“œ -->
      <div class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for dept, dept_users in users_by_dept.items() %}
        <div class="border border-sky-100 rounded-xl shadow-sm p-4 bg-gradient-to-br from-sky-50 to-white">
          <h3 class="text-sky-700 font-semibold text-lg mb-3 cursor-pointer select-none hover:text-sky-600"
              onclick="toggleDepartment('{{ dept }}')">
            {{ dept }}
          </h3>
          <div id="dept-{{ loop.index }}" class="flex flex-wrap gap-2">
            {% for user in dept_users %}
            <div class="user-card border border-sky-200 bg-white rounded-lg px-3 py-1.5 text-sm cursor-pointer select-none transition-all hover:bg-sky-50"
                 data-id="{{ user.id }}" data-dept="{{ dept }}"
                 onclick="toggleUser(this)">
              {{ user.name }}
            </div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>
      <input type="hidden" name="user_ids" id="selectedUsers">
    </form>
  </section>

  <!-- âœ… íƒ­ 2 : ëŒ€ì²´ì—°ì°¨ ì´ë ¥ -->
  <section id="historySection" class="tab-section hidden">
    {% if logs %}
    <div class="space-y-3">
      {% for log in logs %}
      <!-- í¼ì¹¨/ì ‘ê¸° ì¹´ë“œ -->
      <div class="relative border border-sky-100 rounded-lg shadow-sm overflow-hidden transition hover:shadow-md bg-white"
           x-data="{ open: false }">
      
        <!-- âŒ ì‚­ì œ ë²„íŠ¼: button ê¸ˆì§€ â†’ span ì‚¬ìš© -->
        <form method="POST"
              action="{{ url_for('altleave.delete_log', log_id=log.id) }}"
              onsubmit="return confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?');"
              class="absolute right-2 top-2 z-20">
      
          <span class="cursor-pointer text-slate-400 hover:text-red-500 transition"
                onclick="this.closest('form').submit()">
            âœ•
          </span>
        </form>
      
      
        <!-- í¼ì¹¨ ë²„íŠ¼ (button ì•ˆì—ëŠ” button ì ˆëŒ€ ë„£ì§€ ì•ŠìŒ!) -->
        <button @click="open = !open"
                class="w-full flex justify-between items-center px-4 py-3 bg-sky-50 hover:bg-sky-100 transition text-left">
      
          <!-- ë‚ ì§œ + ì‚¬ìœ  -->
          <div class="flex flex-col sm:flex-row sm:items-center sm:gap-4">
            <span class="font-semibold text-slate-700 text-sm sm:text-base">
              {{ log.grant_date.strftime('%Y-%m-%d') }}
            </span>
            <span class="text-slate-600 text-sm truncate max-w-[200px] sm:max-w-[300px]">
              {{ log.reason }}
            </span>
          </div>
      
          <!-- ì˜¤ë¥¸ìª½: ë¶€ì—¬ì¼ìˆ˜ + X ì•„ì´ì½˜ -->
          <div class="flex items-center gap-3">
      
            <span class="text-sky-700 font-semibold text-sm">
              {{ log.add_days }} ì¼
            </span>
      
            <!-- ì—¬ê¸°ë„ button â†’ span ë³€ê²½ -->
            <span class="cursor-pointer text-slate-400 hover:text-red-500 transition"
                  @click.stop="deleteAlt(log.id)">
              <i data-lucide="x" class="w-4 h-4"></i>
            </span>
      
          </div>
      
        </button>  <!-- â¬… ë°˜ë“œì‹œ ë‹«í˜ -->
      
        <!-- í¼ì¹¨ ë‚´ìš© -->
        <div x-show="open" x-transition
             class="px-5 py-3 bg-white border-t border-sky-100 text-sm text-slate-700 space-y-1">
          <p><span class="font-medium text-slate-500">ğŸ“… ì ìš©ì¼ì:</span> {{ log.apply_date }}</p>
          <p><span class="font-medium text-slate-500">ğŸ“ ì‚¬ìœ :</span> {{ log.reason }}</p>
          <p><span class="font-medium text-slate-500">ğŸ‘¥ ì ìš© ë¶€ì„œ ë° ì¸ì›:</span> {{ log.department_summary }}</p>
          <p><span class="font-medium text-slate-500">â±ï¸ ë¶€ì—¬ì¼ìˆ˜:</span>
            <span class="text-sky-600 font-semibold">{{ log.add_days }} ì¼</span>
          </p>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <p class="text-center text-slate-400 text-sm py-4">ì•„ì§ ë¶€ì—¬ëœ ëŒ€ì²´ì—°ì°¨ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </section>

  <!-- âœ… Alpine.js -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</div>

<!-- âœ… JS -->
<script>
const tabs = {
  grant: document.getElementById("tabGrant"),
  history: document.getElementById("tabHistory"),
  grantSec: document.getElementById("grantSection"),
  historySec: document.getElementById("historySection"),
};
tabs.grant.addEventListener("click", () => switchTab("grant"));
tabs.history.addEventListener("click", () => switchTab("history"));

function switchTab(tab) {
  if (tab === "grant") {
    tabs.grant.classList.add("text-sky-600", "border-b-2", "border-sky-500");
    tabs.history.classList.remove("text-sky-600", "border-b-2", "border-sky-500");
    tabs.grantSec.classList.remove("hidden");
    tabs.historySec.classList.add("hidden");
  } else {
    tabs.history.classList.add("text-sky-600", "border-b-2", "border-sky-500");
    tabs.grant.classList.remove("text-sky-600", "border-b-2", "border-sky-500");
    tabs.historySec.classList.remove("hidden");
    tabs.grantSec.classList.add("hidden");
  }
}

// âœ… ì„ íƒ ë¡œì§
let selectedUsers = new Set();
function toggleUser(el) {
  const id = el.dataset.id;
  if (selectedUsers.has(id)) {
    selectedUsers.delete(id);
    el.classList.remove("selected");
  } else {
    selectedUsers.add(id);
    el.classList.add("selected");
  }
  document.getElementById("selectedUsers").value = Array.from(selectedUsers).join(",");
}
function toggleDepartment(deptName) {
  const deptBox = document.querySelector(`[onclick="toggleDepartment('${deptName}')"]`).parentElement;
  const users = deptBox.querySelectorAll(".user-card");
  const allSelected = Array.from(users).every(u => selectedUsers.has(u.dataset.id));
  users.forEach(u => {
    const id = u.dataset.id;
    if (allSelected) {
      selectedUsers.delete(id);
      u.classList.remove("selected");
    } else {
      selectedUsers.add(id);
      u.classList.add("selected");
    }
  });
  document.getElementById("selectedUsers").value = Array.from(selectedUsers).join(",");
}
</script>

<style>
.tab-btn { transition: all 0.15s ease-in-out; }
.tab-btn.active, .tab-btn:hover { color: #0284c7; }
.user-card:hover { border-color: #7dd3fc; }
.user-card.selected { border-color: #0284c7; background-color: #e0f2fe; box-shadow: 0 0 0 2px rgba(14,165,233,0.3); }
</style>
{% endblock %}
