{% extends "base.html" %}
{% block content %}
<div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-lg border border-sky-100 py-4 px-4 md:px-6 mt-[0px] sm:mt-[8px] md:mt-[8px]">

  <!-- ì œëª© ì˜ì—­ -->
  <h2 class="text-xl font-bold text-slate-800 mb-4 text-center md:text-left">
    <!-- ì²« ì¤„: ì•„ì´ì½˜ + íƒ€ì´í‹€ ì •ë ¬ -->
    <div class="flex items-center justify-center md:justify-start gap-2 mb-2">
        <i data-lucide="users" class="w-6 h-6 text-sky-700"></i>
        <span class="text-sky-800 font-bold text-xl md:text-2xl">ì§ì› ê´€ë¦¬</span>
    </div>

    <!-- ğŸ”¹ ë¶€ì„œ ì„ íƒ ì˜ì—­ (ì´ê´€ë¦¬ì ì „ìš©) -->
    {% if is_superadmin and departments %}
      <form method="get"
            action="{{ url_for('employee.employee_list') }}"
            class="flex items-center gap-2 text-sm md:text-base mb-4">

        <label for="deptSelect" class="text-slate-700 font-medium">
          ë¶€ì„œ ì„ íƒ:
        </label>

        <select id="deptSelect"
                name="dept"
                class="border border-sky-300 rounded-lg px-3 py-1 text-sky-800 bg-white shadow-sm text-sm"
                onchange="this.form.submit()">

          <!-- âœ… ì „ì²´ -->
          <option value="all" {% if current_dept in [None, '', 'all'] %}selected{% endif %}>ì „ì²´</option>

          {% for d in departments %}
            <option value="{{ d }}" {% if d == current_dept %}selected{% endif %}>
              {{ d }}
            </option>
          {% endfor %}
        </select>
      </form>
    {% endif %}
  </h2>


  {% if employees %}
<!-- í…Œì´ë¸” ë˜í¼ -->
<div class="rounded-xl border border-sky-100 shadow-inner overflow-hidden table-container">
  <div class="overflow-x-auto">
    <table class="min-w-full text-sm border-collapse">
        <thead class="bg-gradient-to-r from-sky-50 to-sky-100 text-sky-700 border-b border-sky-200">
          <tr>
            <th class="py-2 px-2 border-r border-sky-200">
              {% if sort == 'name' %}
                <!-- ë‹¤ì‹œ ëˆ„ë¥´ë©´ ì›ë˜ëŒ€ë¡œ -->
                <a href="{{ url_for('employee.employee_list', dept=current_dept) }}"
                  class="inline-flex items-center gap-1 hover:text-sky-700">
                  ì´ë¦„
                </a>
              {% else %}
                <a href="{{ url_for('employee.employee_list', dept=current_dept, sort='name') }}"
                  class="inline-flex items-center gap-1 hover:text-sky-700">
                  ì´ë¦„
                </a>
              {% endif %}
            </th>
            <th class="py-2 px-2 border-r border-sky-200">ì•„ì´ë””</th>
            {% if is_superadmin %}
              <th class="py-2 px-2 border-r border-sky-200">ì „í™”ë²ˆí˜¸</th>
            {% endif %}
            <th class="py-2 px-2 border-r border-sky-200">
              {% if sort == 'join_date' %}
                <a href="{{ url_for('employee.employee_list', dept=current_dept) }}"
                  class="inline-flex items-center gap-1 hover:text-sky-700">
                  ì…ì‚¬ì¼
                </a>
              {% else %}
                <a href="{{ url_for('employee.employee_list', dept=current_dept, sort='join_date') }}"
                  class="inline-flex items-center gap-1 hover:text-sky-700">
                  ì…ì‚¬ì¼
                </a>
              {% endif %}
            </th>
            <th class="py-2 px-2 border-r border-sky-200">ì´ ì—°ì°¨</th>
            {% if is_superadmin %}
              <th class="py-2 px-2 border-r border-sky-200">ëŒ€ì²´ì—°ì°¨</th>
            {% endif %}
            <th class="py-2 px-2 border-r border-sky-200">ì‚¬ìš©</th>
            <th class="py-2 px-2 border-r border-sky-200">ì”ì—¬</th>
            {% if is_superadmin %}
              <th class="py-2 px-2 border-r border-sky-200">ê´€ë¦¬ì ì§€ì •</th>
              <th class="py-2 px-2 border-r border-sky-200">ì„œëª…</th>
              <th class="py-2 px-2 border-r border-sky-200">ìˆ˜ì •</th>
              <th class="py-2 px-2">ì‚­ì œ</th>
            {% endif %}
          </tr>
        </thead>

        <tbody class="divide-y divide-slate-100">
          {% for emp in employees %}
          <tr class="text-center hover:bg-sky-50 transition" id="employee-row-{{ emp.id }}">
            <td class="py-2 border-r border-slate-100 font-medium">{{ emp.name }}</td>
            <td class="py-2 border-r border-slate-100">{{ emp.username }}</td>
            {% if is_superadmin %}
              <td class="py-2 border-r border-slate-100">
                {{ emp.phone or "-" }}
              </td>
            {% endif %}
            <td class="py-2 border-r border-slate-100">
              {% if emp.join_date and emp.join_date != 'None' %}
                {% if emp.join_date.__class__.__name__ in ['date', 'datetime'] %}
                  {{ emp.join_date.strftime('%y.%m.%d') }}
                {% else %}
                  {{ emp.join_date[:10].replace('-', '.')[2:] }}
                {% endif %}
              {% else %}-{% endif %}
            </td>

            <!-- ì´ì—°ì°¨ -->
            <td class="py-2 border-r border-slate-100 text-sky-800 font-semibold">
              {% if is_superadmin %}
                {{ emp.total_leave }}
              {% else %}
                {{ emp.total_leave }} ({{ "%.2f"|format(emp.total_alt_leave or 0) }})
              {% endif %}
            </td>

            <!-- ëŒ€ì²´ì—°ì°¨ (ì´ê´€ë¦¬ì ì „ìš©) -->
            {% if is_superadmin %}
            <td class="py-2 border-r border-slate-100 text-amber-600 font-semibold">
              {{ "%.2f"|format(emp.total_alt_leave or 0) }}
            </td>
            {% endif %}

            <!-- ì‚¬ìš© -->
            <td class="py-2 border-r border-slate-100 font-medium text-blue-600">
            {{ "%.2f"|format(emp.used_total or 0) }}
            </td>

            <!-- ì”ì—¬ (ìŒìˆ˜ì¼ ë•Œ ë¹¨ê°„ìƒ‰) -->
            <td class="py-2 border-r border-slate-100 font-semibold">
                <span class="{% if emp.remaining_days < 0 %}text-red-600{% else %}text-green-600{% endif %}">
                    {{ "%.2f"|format(emp.remaining_days or 0) }}
                </span>
                <span class="text-slate-500">
                    ({{ "%.2f"|format(emp.alt_left or 0) }})
                </span>
            </td>


            {% if is_superadmin %}
              <!-- ê´€ë¦¬ì ì§€ì • -->
              <td class="py-2 border-r border-slate-100">
                <button
                  class="toggle-admin-btn text-xs px-2 py-1 rounded border border-slate-300 transition
                        {% if emp.is_admin %}
                          bg-amber-300 hover:bg-amber-400 text-slate-800
                        {% else %}
                          bg-gray-100 hover:bg-gray-200 text-slate-600
                        {% endif %}"
                  data-user-id="{{ emp.id }}">
                  {% if emp.is_admin %}í•´ì œ{% else %}ì§€ì •{% endif %}
                </button>
              </td>

              <!-- âœ… ì„œëª… -->
              {% set sig_fn = emp.signature_image.split('/')[-1] if emp.signature_image else '' %}
              {% set sig_url = url_for('employee.signature_file', filename=sig_fn) if sig_fn else '' %}

              <td class="py-2 border-r border-slate-100 text-center"
                  id="sig-cell-{{ emp.id }}"
                  data-user-id="{{ emp.id }}"
                  data-sig-url="{{ sig_url }}">

                <div class="flex items-center justify-center gap-2">
                  {% if sig_url %}
                    <button type="button"
                            class="sig-open-btn text-xs px-2 py-1 rounded bg-white border border-slate-300 hover:bg-sky-50 text-sky-700"
                            data-mode="view">
                      ë³´ê¸°
                    </button>
                    <button type="button"
                            class="sig-delete-btn text-xs px-2 py-1 rounded bg-rose-500 text-white hover:bg-rose-600"
                            data-user-id="{{ emp.id }}">
                      ì‚­ì œ
                    </button>
                  {% else %}
                    <button type="button"
                            class="sig-open-btn text-xs px-2 py-1 rounded bg-sky-600 text-white hover:bg-sky-700"
                            data-mode="add">
                      ì¶”ê°€
                    </button>
                  {% endif %}
                </div>
              </td>

              <!-- ìˆ˜ì • -->
              <td class="py-2 border-r border-slate-100">
                <a href="{{ url_for('employee.edit_employee', emp_id=emp.id) }}"
                   class="text-xs px-2 py-1 rounded border border-slate-300 bg-sky-100 hover:bg-sky-200 text-sky-700 transition">
                   âœ ìˆ˜ì •
                </a>
              </td>

              <!-- ì‚­ì œ -->
              <td class="py-2">
                <button
                  class="text-rose-600 hover:text-rose-700 hover:underline text-xs delete-employee-btn"
                  data-user-id="{{ emp.id }}"
                  data-delete-url="{{ url_for('employee.delete_employee', emp_id=emp.id) }}">
                  ì‚­ì œ
                </button>
              </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
  <p class="text-center text-slate-500 text-sm mt-3">ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>
  {% endif %}
</div>

<!-- âœ… ë°˜ì‘í˜• (ëª¨ë°”ì¼ ìŠ¤í¬ë¡¤ + ì¤„ë°”ê¿ˆ ë°©ì§€) -->
<style>
/* ëª¨ë“  ì…€ ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
th, td {
  white-space: nowrap;
}

/* ëª¨ë°”ì¼ ì „ìš© ìŠ¤í¬ë¡¤ í™œì„±í™” */
@media (max-width: 768px) {
  .table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
  }
  table {
    min-width: 700px; /* ìŠ¤í¬ë¡¤ ì—¬ìœ  */
    font-size: 0.85rem;
  }
}
</style>
<!-- ===============================
    ì„œëª… ì—…ë¡œë“œ ëª¨ë‹¬ (ì´ê´€ë¦¬ì)
=============================== -->
<div id="signatureModal" style="display:none;" class="fixed inset-0 bg-black/40 z-50">
  <div class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-xl w-96 p-6 shadow-lg">
    <h3 class="text-lg font-bold text-sky-700 mb-4">
      ì„œëª… ì´ë¯¸ì§€ ì—…ë¡œë“œ
    </h3>
    <!-- âœ… ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ (ì—¬ê¸°ì— ë„£ê¸°) -->
    <div class="mb-4">
      <p class="text-xs text-slate-500 mb-2">ë¯¸ë¦¬ë³´ê¸°</p>

      <div class="border rounded-lg bg-slate-50 p-2 flex items-center justify-center">
        <img id="signaturePreview"
            src=""
            alt="signature preview"
            class="hidden max-h-28 object-contain">
        <div id="signatureEmptyText" class="text-xs text-slate-400">
          ë“±ë¡ëœ ì„œëª…ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
      </div>
    </div>

    <form id="signatureForm" enctype="multipart/form-data">
      <input type="hidden" name="user_id" id="signatureUserId">

      <input type="file"
            name="signature"
            accept="image/png, image/jpg, image/jpeg"
            required
            class="block w-full text-sm mb-4">

      <div class="flex justify-end gap-2">
        <button type="button"
                onclick="closeSignatureModal()"
                class="px-3 py-1 rounded bg-gray-300 text-sm">
          ì·¨ì†Œ
        </button>

        <button id="sigSaveBtn" type="submit"
                class="px-3 py-1 rounded bg-sky-600 text-white text-sm">
          ì €ì¥
        </button>
      </div>
    </form>
    </div>
  </div>
</div>

<!-- JS ê·¸ëŒ€ë¡œ ìœ ì§€ -->
<script>
/* ===== ìˆ˜ì • 1) ë¯¸ë¦¬ë³´ê¸° + ì…€ ê°±ì‹  ìœ í‹¸ ===== */
function setPreview(url) {
  const img = document.getElementById("signaturePreview");
  const empty = document.getElementById("signatureEmptyText");
  if (!img || !empty) return;

  if (!url) {
    img.src = "";
    img.classList.add("hidden");
    empty.classList.remove("hidden");
    return;
  }

  // âœ… blob/dataëŠ” ?v ê°™ì€ ì¿¼ë¦¬ ë¶™ìœ¼ë©´ ê¹¨ì§ â†’ ë“¤ì–´ì˜¨ ê°’ì— ì¿¼ë¦¬ê°€ ìˆìœ¼ë©´ ì˜ë¼ë²„ë¦¼
  const isBlob = url.startsWith("blob:");
  const isData = url.startsWith("data:");
  if ((isBlob || isData) && url.includes("?")) {
    url = url.split("?")[0];
  }

  if (isBlob || isData) {
    img.src = url;
  } else {
    img.src = url + (url.includes("?") ? "&" : "?") + "v=" + Date.now();
  }

  img.classList.remove("hidden");
  empty.classList.add("hidden");
}

function updateSignatureCell(userId, sigUrl) {
  const cell = document.getElementById(`sig-cell-${userId}`);
  if (!cell) return;

  cell.dataset.userId = userId;   // âœ… ì¶”ê°€ (ì•ˆì •ì„±)
  cell.dataset.sigUrl = sigUrl || "";
  
  if (sigUrl) {
    cell.innerHTML = `
        <div class="flex items-center justify-center gap-2">
            <button type="button"
                    class="sig-open-btn text-xs px-2 py-1 rounded bg-white border border-slate-300 hover:bg-sky-50 text-sky-700"
                    data-mode="view">ë³´ê¸°</button>

            <button type="button"
                    class="sig-delete-btn text-xs px-2 py-1 rounded bg-rose-500 text-white hover:bg-rose-600"
                    data-user-id="${userId}">ì‚­ì œ</button>
        </div>
    `;
  } else {
        cell.innerHTML = `
            <div class="flex items-center justify-center gap-2">
                <button type="button"
                        class="sig-open-btn text-xs px-2 py-1 rounded bg-sky-600 text-white hover:bg-sky-700"
                        data-mode="add">ì¶”ê°€</button>
                </div>
    `;
  }
}

document.addEventListener("DOMContentLoaded", () => {
  // âœ… ê´€ë¦¬ì ì§€ì • ë²„íŠ¼
  document.querySelectorAll(".toggle-admin-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.userId;
      try {
        const res = await axios.post(`/employee/toggle_admin/${id}`);
        if (res.data && res.data.status === "success") {
          // ì§€ê¸ˆ í´ë¦­ í›„ ìƒíƒœê°€ "ê´€ë¦¬ìë¡œ ì§€ì •ëœ ìƒíƒœ"ì¸ì§€
          const isNowAdmin = btn.textContent.trim() === "ì§€ì •";

          // í…ìŠ¤íŠ¸ ë³€ê²½
          btn.textContent = isNowAdmin ? "í•´ì œ" : "ì§€ì •";

          // ğŸ”¹ ìƒ‰/ìŠ¤íƒ€ì¼ì„ ëª…í™•í•˜ê²Œ ê°ˆì•„ë¼ìš°ê¸°
          if (isNowAdmin) {
            // ğŸ‘‰ ì´ì œ 'ê´€ë¦¬ì' ìƒíƒœ
            btn.classList.remove("bg-gray-100", "hover:bg-gray-200", "text-slate-600");
            btn.classList.add("bg-amber-300", "hover:bg-amber-400", "text-slate-800");
          } else {
            // ğŸ‘‰ ë‹¤ì‹œ ì¼ë°˜ ì§ì› ìƒíƒœ
            btn.classList.remove("bg-amber-300", "hover:bg-amber-400", "text-slate-800");
            btn.classList.add("bg-gray-100", "hover:bg-gray-200", "text-slate-600");
          }

          alert(res.data.message || "ê´€ë¦¬ì ê¶Œí•œì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
          alert(res.data.message || "ì²˜ë¦¬ ì‹¤íŒ¨");
        }
      } catch (err) {
        console.error(err);
        alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });
  });

  document.querySelectorAll(".delete-employee-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.userId;
      if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      try {
        const res = await axios.post(`/employee/delete/${id}`);
        if (res.data && res.data.status === "success") {
          document.getElementById(`employee-row-${id}`).remove();
          alert("ì§ì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
          alert(res.data.message || "ì‚­ì œ ì‹¤íŒ¨");
        }
      } catch (err) {
        alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });
  });
});
/* ===== ìˆ˜ì • 2) ì„œëª… ë²„íŠ¼(ë³´ê¸°/ë³€ê²½/ì¶”ê°€) í´ë¦­ â†’ ëª¨ë‹¬ ì˜¤í”ˆ (ì´ë²¤íŠ¸ ìœ„ì„) ===== */
document.addEventListener("click", (e) => {
  const btn = e.target.closest(".sig-open-btn");
  if (!btn) return;

  const cell = btn.closest("td[id^='sig-cell-']");
  if (!cell) return;

  const userId = cell.dataset.userId;
  const sigUrl = cell.dataset.sigUrl || "";
  const mode = btn.dataset.mode;

  openSignatureModal(userId, sigUrl);

  // âœ… ì¶”ê°€(add)ì¼ ë•Œë§Œ íŒŒì¼ì„ íƒì°½ ìë™ ì˜¤í”ˆ
  if (mode === "add") {
    setTimeout(() => {
      document.querySelector("#signatureForm input[type='file']")?.click();
    }, 150);
  }
});

function openSignatureModal(userId, sigUrl) {
  document.getElementById("signatureUserId").value = userId;

  const fileInput = document.querySelector("#signatureForm input[type='file']");
  if (fileInput) fileInput.value = "";

  setPreview(sigUrl);

  const modal = document.getElementById("signatureModal");
  modal.style.display = "block";  // âœ… ê°•ì œ ì˜¤í”ˆ
}

function closeSignatureModal() {
  const modal = document.getElementById("signatureModal");
  modal.style.display = "none";   // âœ… ê°•ì œ ë‹«ê¸°
  setPreview("");                 // ë‹¤ìŒì— ì—´ ë•Œ ê¹¨ì§„ ë¯¸ë¦¬ë³´ê¸° ë°©ì§€
}


/* íŒŒì¼ ì„ íƒ ì¦‰ì‹œ ë¡œì»¬ ë¯¸ë¦¬ë³´ê¸° */
document.querySelector("#signatureForm input[type='file']")?.addEventListener("change", function () {
  if (this.files && this.files[0]) {
    const tempUrl = URL.createObjectURL(this.files[0]);
    setPreview(tempUrl);
  }
});


// âœ… ì„œëª… ì—…ë¡œë“œ ì²˜ë¦¬ (ì´ë²¤íŠ¸ ìœ„ì„ - ì €ì¥ ë²„íŠ¼ ë¨¹í†µ í•´ê²°)
document.addEventListener("submit", async (e) => {
  if (e.target && e.target.id === "signatureForm") {
    e.preventDefault();

    console.log("âœ… signatureForm submit caught"); // ë””ë²„ê¹…ìš©

    const form = e.target;
    const formData = new FormData(form);

    try {
      const res = await fetch("/employee/upload_signature", {
        method: "POST",
        body: formData
      });

      const data = await res.json();
      console.log("âœ… upload response:", data); // ë””ë²„ê¹…ìš©

      if (data.status === "success") {
        const userId = document.getElementById("signatureUserId").value;

        setPreview(data.signature_url);
        updateSignatureCell(userId, data.signature_url);

        closeSignatureModal(); // ì›í•˜ë©´ ë‹«ê¸°
      } else {
        alert(data.message || "ì—…ë¡œë“œ ì‹¤íŒ¨");
      }
    } catch (err) {
      console.error(err);
      alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  }
});

// âœ… ì„œëª… ì‚­ì œ ë²„íŠ¼ ì²˜ë¦¬
document.addEventListener("click", async (e) => {
  const btn = e.target.closest(".sig-delete-btn");
  if (!btn) return;

  const userId = btn.dataset.userId;
  if (!confirm("ì„œëª…ì„ ì‚­ì œí• ê¹Œìš”?")) return;

  try {
    const res = await fetch(`/employee/delete_signature/${userId}`, { method: "POST" });
    const data = await res.json();

    if (data.status === "success") {
      updateSignatureCell(userId, ""); // ì¦‰ì‹œ 'ì¶”ê°€'ë¡œ ë³€ê²½
      closeSignatureModal();           // ëª¨ë‹¬ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
    } else {
      alert(data.message || "ì‚­ì œ ì‹¤íŒ¨");
    }
  } catch (err) {
    console.error(err);
    alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
});

</script>
{% endblock %}
