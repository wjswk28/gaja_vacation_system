{% extends "base.html" %}
{% block content %}
<div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-lg border border-sky-100 py-4 px-4 md:px-6 mt-[0px] sm:mt-[8px] md:mt-[8px]">

  <!-- ì œëª© ì˜ì—­ -->
  <h2 class="text-xl font-bold text-slate-800 mb-4 text-center md:text-left">
    <!-- ì²« ì¤„: ì•„ì´ì½˜ + íƒ€ì´í‹€ ì •ë ¬ -->
    <div class="flex items-center justify-center md:justify-start gap-2 mb-2">
        <i data-lucide="users" class="w-6 h-6 text-sky-700"></i>
        <span class="text-sky-800 font-bold text-xl md:text-2xl">ì§ì› ê´€ë¦¬</span>
    </div>

    <!-- ğŸ”¹ ë¶€ì„œ ì„ íƒ ì˜ì—­ (ì´ê´€ë¦¬ì ì „ìš©) -->
    {% if is_superadmin and departments %}
      <form method="get"
            action="{{ url_for('employee.employee_list') }}"
            class="flex items-center gap-2 text-sm md:text-base mb-4">

        <label for="deptSelect" class="text-slate-700 font-medium">
          ë¶€ì„œ ì„ íƒ:
        </label>

        <select id="deptSelect"
                name="dept"
                class="border border-sky-300 rounded-lg px-3 py-1 text-sky-800 bg-white shadow-sm text-sm"
                onchange="this.form.submit()">
          {% for d in departments %}
            <option value="{{ d }}" {% if d == current_dept %}selected{% endif %}>
              {{ d }}
            </option>
          {% endfor %}
        </select>
      </form>
    {% endif %}
  </h2>


  {% if employees %}
<!-- í…Œì´ë¸” ë˜í¼ -->
<div class="rounded-xl border border-sky-100 shadow-inner overflow-hidden table-container">
  <div class="overflow-x-auto">
    <table class="min-w-full text-sm border-collapse">
        <thead class="bg-gradient-to-r from-sky-50 to-sky-100 text-sky-700 border-b border-sky-200">
          <tr>
            <th class="py-2 px-2 border-r border-sky-200">ì´ë¦„</th>
            <th class="py-2 px-2 border-r border-sky-200">ì•„ì´ë””</th>
            <th class="py-2 px-2 border-r border-sky-200">ì…ì‚¬ì¼</th>
            <th class="py-2 px-2 border-r border-sky-200">ì´ ì—°ì°¨</th>
            {% if is_superadmin %}
              <th class="py-2 px-2 border-r border-sky-200">ëŒ€ì²´ì—°ì°¨</th>
            {% endif %}
            <th class="py-2 px-2 border-r border-sky-200">ì‚¬ìš©</th>
            <th class="py-2 px-2 border-r border-sky-200">ì”ì—¬</th>
            {% if is_superadmin %}
              <th class="py-2 px-2 border-r border-sky-200">ê´€ë¦¬ì ì§€ì •</th>
              <th class="py-2 px-2 border-r border-sky-200">ìˆ˜ì •</th>
              <th class="py-2 px-2">ì‚­ì œ</th>
            {% endif %}
          </tr>
        </thead>

        <tbody class="divide-y divide-slate-100">
          {% for emp in employees %}
          <tr class="text-center hover:bg-sky-50 transition" id="employee-row-{{ emp.id }}">
            <td class="py-2 border-r border-slate-100 font-medium">{{ emp.name }}</td>
            <td class="py-2 border-r border-slate-100">{{ emp.username }}</td>
            <td class="py-2 border-r border-slate-100">
              {% if emp.join_date and emp.join_date != 'None' %}
                {% if emp.join_date.__class__.__name__ in ['date', 'datetime'] %}
                  {{ emp.join_date.strftime('%y.%m.%d') }}
                {% else %}
                  {{ emp.join_date[:10].replace('-', '.')[2:] }}
                {% endif %}
              {% else %}-{% endif %}
            </td>

            <!-- ì´ì—°ì°¨ -->
            <td class="py-2 border-r border-slate-100 text-sky-800 font-semibold">
              {% if is_superadmin %}
                {{ emp.total_leave }}
              {% else %}
                {{ emp.total_leave }} ({{ "%.2f"|format(emp.total_alt_leave or 0) }})
              {% endif %}
            </td>

            <!-- ëŒ€ì²´ì—°ì°¨ (ì´ê´€ë¦¬ì ì „ìš©) -->
            {% if is_superadmin %}
            <td class="py-2 border-r border-slate-100 text-amber-600 font-semibold">
              {{ "%.2f"|format(emp.total_alt_leave or 0) }}
            </td>
            {% endif %}

            <!-- ì‚¬ìš© -->
            <td class="py-2 border-r border-slate-100 font-medium text-blue-600">
            {{ "%.2f"|format(emp.used_total or 0) }}
            </td>

            <!-- ì”ì—¬ (ìŒìˆ˜ì¼ ë•Œ ë¹¨ê°„ìƒ‰) -->
            <td class="py-2 border-r border-slate-100 font-semibold">
                <span class="{% if emp.remaining_days < 0 %}text-red-600{% else %}text-green-600{% endif %}">
                    {{ "%.2f"|format(emp.remaining_days or 0) }}
                </span>
                <span class="text-slate-500">
                    ({{ "%.2f"|format(emp.alt_left or 0) }})
                </span>
            </td>


            {% if is_superadmin %}
              <!-- ê´€ë¦¬ì ì§€ì • -->
              <td class="py-2 border-r border-slate-100">
                <button
                  class="toggle-admin-btn text-xs px-2 py-1 rounded border border-slate-300 transition
                        {% if emp.is_admin %}
                          bg-amber-300 hover:bg-amber-400 text-slate-800
                        {% else %}
                          bg-gray-100 hover:bg-gray-200 text-slate-600
                        {% endif %}"
                  data-user-id="{{ emp.id }}">
                  {% if emp.is_admin %}í•´ì œ{% else %}ì§€ì •{% endif %}
                </button>
              </td>

              <!-- ìˆ˜ì • -->
              <td class="py-2 border-r border-slate-100">
                <a href="{{ url_for('employee.edit_employee', emp_id=emp.id) }}"
                   class="text-xs px-2 py-1 rounded border border-slate-300 bg-sky-100 hover:bg-sky-200 text-sky-700 transition">
                   âœ ìˆ˜ì •
                </a>
              </td>

              <!-- ì‚­ì œ -->
              <td class="py-2">
                <button
                  class="text-rose-600 hover:text-rose-700 hover:underline text-xs delete-employee-btn"
                  data-user-id="{{ emp.id }}"
                  data-delete-url="{{ url_for('employee.delete_employee', emp_id=emp.id) }}">
                  ì‚­ì œ
                </button>
              </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% else %}
  <p class="text-center text-slate-500 text-sm mt-3">ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>
  {% endif %}
</div>

<!-- âœ… ë°˜ì‘í˜• (ëª¨ë°”ì¼ ìŠ¤í¬ë¡¤ + ì¤„ë°”ê¿ˆ ë°©ì§€) -->
<style>
/* ëª¨ë“  ì…€ ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
th, td {
  white-space: nowrap;
}

/* ëª¨ë°”ì¼ ì „ìš© ìŠ¤í¬ë¡¤ í™œì„±í™” */
@media (max-width: 768px) {
  .table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
  }
  table {
    min-width: 700px; /* ìŠ¤í¬ë¡¤ ì—¬ìœ  */
    font-size: 0.85rem;
  }
}
</style>

<!-- JS ê·¸ëŒ€ë¡œ ìœ ì§€ -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  // âœ… ê´€ë¦¬ì ì§€ì • ë²„íŠ¼
  document.querySelectorAll(".toggle-admin-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.userId;
      try {
        const res = await axios.post(`/employee/toggle_admin/${id}`);
        if (res.data && res.data.status === "success") {
          // ì§€ê¸ˆ í´ë¦­ í›„ ìƒíƒœê°€ "ê´€ë¦¬ìë¡œ ì§€ì •ëœ ìƒíƒœ"ì¸ì§€
          const isNowAdmin = btn.textContent.trim() === "ì§€ì •";

          // í…ìŠ¤íŠ¸ ë³€ê²½
          btn.textContent = isNowAdmin ? "í•´ì œ" : "ì§€ì •";

          // ğŸ”¹ ìƒ‰/ìŠ¤íƒ€ì¼ì„ ëª…í™•í•˜ê²Œ ê°ˆì•„ë¼ìš°ê¸°
          if (isNowAdmin) {
            // ğŸ‘‰ ì´ì œ 'ê´€ë¦¬ì' ìƒíƒœ
            btn.classList.remove("bg-gray-100", "hover:bg-gray-200", "text-slate-600");
            btn.classList.add("bg-amber-300", "hover:bg-amber-400", "text-slate-800");
          } else {
            // ğŸ‘‰ ë‹¤ì‹œ ì¼ë°˜ ì§ì› ìƒíƒœ
            btn.classList.remove("bg-amber-300", "hover:bg-amber-400", "text-slate-800");
            btn.classList.add("bg-gray-100", "hover:bg-gray-200", "text-slate-600");
          }

          alert(res.data.message || "ê´€ë¦¬ì ê¶Œí•œì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
          alert(res.data.message || "ì²˜ë¦¬ ì‹¤íŒ¨");
        }
      } catch (err) {
        console.error(err);
        alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });
  });

  document.querySelectorAll(".delete-employee-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.userId;
      if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      try {
        const res = await axios.post(`/employee/delete/${id}`);
        if (res.data && res.data.status === "success") {
          document.getElementById(`employee-row-${id}`).remove();
          alert("ì§ì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
          alert(res.data.message || "ì‚­ì œ ì‹¤íŒ¨");
        }
      } catch (err) {
        alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });
  });
});
</script>
{% endblock %}
